<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="styleP.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <title>Página Pesquisa</title>
</head>
<body>
    
    <form id="pesquisaForm">
        <a href="/"><i class="bi bi-arrow-left"></i></a>
        <h1>Pesquisar Produto</h1>
        <label for="pesquisaCodigo">Código do Produto:</label>
        <input type="text" id="pesquisaCodigo" name="pesquisaCodigo" required>
        <div class="bntCrud">
        <button type="button" onclick="pesquisarProduto()">Pesquisar Produto</button>
        <button class="atualizar" type="button" onclick="atualizarProduto()">Atualizar Produto</button>
        <button class="deletar" type="button" onclick="deletarProduto()">Deletar Produto</button>
        </div>
    </form>

    <div id="resultadoPesquisa"></div>

    <script>
        function carregarResultados() {
            const resultadoDiv = document.getElementById('resultadoPesquisa');
            resultadoDiv.innerHTML = '';

            const dados = localStorage.getItem('dadosProduto');

            if (dados) {
                const resultados = JSON.parse(dados);
                let html = "<h3 class='resultado-titulo'>Informações do Produto:</h3>";
                html += "<div class='informacoes-produto'>";
                resultados.forEach(item => {
                    html += `<p>Rua: ${item.rua}</p>`;
                    html += `<p>Rack: ${item.rack}</p>`;
                    html += `<p>Altura: ${item.altura}</p>`;
                    html += `<p>Posição: ${item.posicao}</p>`;
                    html += `<p>Quantidade: ${item.quantidade}</p>`;
                    html += `<p>Categoria: ${item.categoria}</p>`;
                    html += `<p>Descrição: ${item.produto}</p>`;
                    html += `<hr>`; // Linha separadora
                });
                html += "</div>";
                resultadoDiv.innerHTML = html;
            }
        }

        function pesquisarProduto() {
            const codigo = document.getElementById('pesquisaCodigo').value;
            const resultadoDiv = document.getElementById('resultadoPesquisa');
            resultadoDiv.innerHTML = ''; // Limpa os resultados antes de mostrar novos

            fetch(`http://localhost:3000/pesquisar/${codigo}`, {
                method: 'GET',
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    let html = "<h3 class='resultado-titulo'>Informações do Produto:</h3>";
                    html += "<div class='informacoes-produto'>";

                    result.dados.forEach(item => {
                        html += `<p>RUA: ${item.rua}</p>`;
                        html += `<p>RACK: ${item.rack}</p>`;
                        html += `<p>ALTURA: ${item.altura}</p>`;
                        html += `<p>POSIÇÃO: ${item.posicao}</p>`;
                        html += `<p>QUANTIDADE: ${item.quantidade}</p>`;
                        html += `<p>CATEGORIA: ${item.categoria}</p>`;
                        html += `<p>DESCRIÇÃO: ${item.produto}</p>`;
                        html += `<hr>`; // Linha separadora
                    });

                    resultadoDiv.innerHTML = html;
                    localStorage.setItem('dadosProduto', JSON.stringify(result.dados));
                } else {
                    resultadoDiv.innerHTML = `<p>${result.message}</p>`;
                }
            })
            .catch(error => console.error('Erro:', error));
        }

        function deletarProduto() {
            const codigo = document.getElementById('pesquisaCodigo').value;
            fetch(`http://localhost:3000/pesquisar/${codigo}`, {
                method: 'GET',
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    const posicoes = result.dados.map(item => item.posicao);
                    const posicaoParaDeletar = prompt("Qual posição você deseja deletar? Opções: " + posicoes.join(', '));

                    if (posicoes.includes(posicaoParaDeletar)) {
                        fetch(`http://localhost:3000/deletar/${codigo}/${posicaoParaDeletar}`, {
                            method: 'DELETE',
                        })
                        .then(response => response.json())
                        .then(result => {
                            if (result.success) {
                                alert(result.message);
                                localStorage.removeItem('dadosProduto'); // Remove do localStorage
                                document.getElementById('resultadoPesquisa').innerHTML = ''; // Limpa o resultado da pesquisa
                            } else {
                                alert('Erro ao deletar o produto: ' + result.message);
                            }
                        })
                        .catch(error => console.error('Erro:', error));
                    } else {
                        alert("Posição inválida!");
                    }
                } else {
                    alert('Erro ao pesquisar o produto: ' + result.message);
                }
            })
            .catch(error => console.error('Erro:', error));
        }

        //ARRUMAR, NAO FUNCIONA
        function atualizarProduto() {
    const codigo = document.getElementById('pesquisaCodigo').value;
    fetch(`http://localhost:3000/pesquisar/${codigo}`, {
        method: 'GET',
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            const posicoes = result.dados.map(item => item.posicao);
            const posicaoParaAtualizar = prompt("Qual posição você deseja atualizar? Opções: " + posicoes.join(', '));

            if (posicoes.includes(posicaoParaAtualizar)) {
                fetch(`http://localhost:3000/atualizar/${codigo}/${posicaoParaAtualizar}`, {
                    method: 'PUT', // ou PATCH dependendo da sua API
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert(result.message);
                        localStorage.removeItem('dadosProduto'); // Remove do localStorage
                        document.getElementById('resultadoPesquisa').innerHTML = ''; // Limpa o resultado da pesquisa
                    } else {
                        alert('Erro ao atualizar o produto: ' + result.message);
                    }
                })
                .catch(error => console.error('Erro:', error));
            } else {
                alert("Posição inválida!");
            }
        } else {
            alert('Erro ao pesquisar o produto: ' + result.message);
        }
    })
    .catch(error => console.error('Erro:', error));
}

    </script>
</body>
</html>
